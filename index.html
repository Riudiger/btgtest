<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Atendimento Telef√¥nico</title>

<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<script>
Backendless.initApp(
  "16519BB0-2CC5-4D6D-A7C8-CC9B9D69F91B",
  "FD19561E-7DE2-4E6B-AA75-2C846AF62F87"
);
</script>

<style>
*{ box-sizing:border-box; font-family:Arial }
body{ margin:0; background:#f4f6f8; color:#0f172a; }
header{ background:#001e36; color:#fff; padding:15px; text-align:center; font-size:20px; font-weight:bold; position:relative }
.admin-btn{ position:absolute; right:20px; top:12px; background:#0b3c5d; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer }
.admin-panel{ position:fixed; top:60px; right:20px; width:360px; background:#fff; padding:20px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); display:none; z-index:999 }
.admin-panel h2{ margin-top:0; color:#001e36 }
.admin-panel button.close{ background:#b91c1c; color:#fff; width:100%; margin-top:10px }
.container{ max-width:1300px; margin:20px auto; padding:20px }
.card{ background:#fff; padding:20px; border-radius:14px; margin-bottom:20px; box-shadow:0 6px 18px rgba(0,0,0,.08) }
h2{ margin-top:0; color:#001e36 }
input,select,button{ padding:10px; border-radius:8px; border:1px solid #cbd5e1 }
button{ cursor:pointer; font-weight:bold }
.pause-buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
.pause-buttons button{ background:#e5e7eb; color:#001e36 }
.pause-buttons button:hover{ background:#cbd5e1 }
.adm{ border:2px dashed #001e36 }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px }
table{ width:100%; border-collapse:collapse }
th,td{ border:1px solid #e5e7eb; padding:8px; text-align:center }
th{ background:#eef2f6; color:#001e36 }
.status{ display:flex; align-items:center; justify-content:center; gap:6px; font-weight:bold }
.bolinha{ width:10px; height:10px; border-radius:50% }
.verde{ background:#16a34a; color:#14532d }
.vermelho{ background:#dc2626; color:#7f1d1d }
.badge{ padding:3px 8px; border-radius:10px; font-size:12px; font-weight:bold }
.chat{ background:#e0f2fe; color:#075985 }
.telefone{ background:#e5e7eb; color:#001e36 }
.lista-analistas{ margin-top:15px }
.lista-analistas div{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px }
.lista-analistas button{ padding:4px 8px; font-size:12px }
</style>
</head>

<body>

<header>
üìû Painel de Atendimento
<button class="admin-btn" onclick="toggleAdmin()">üõ†Ô∏è Admin</button>
</header>

<div class="admin-panel" id="adminPanel">
<h2>üë§ Cadastro do Analista</h2>

<input id="analistaNome" placeholder="Nome do Analista"><br><br>

<select id="analistaCanal">
<option value="">Canal</option>
<option value="Telefone">üìû Telefone</option>
<option value="Chat">üí¨ Chat</option>
</select><br><br>

<button onclick="cadastrarAnalista()">Salvar</button>

<div class="lista-analistas" id="listaAnalistas"></div>

<button class="close" onclick="toggleAdmin()">Fechar</button>
</div>

<div class="container">

<div class="card">
<h2>‚è∏Ô∏è Controle de Pausas</h2>

<select id="selectAnalista">
<option value="">Selecione o analista</option>
</select><br><br>

<div class="pause-buttons">
<button onclick="iniciarPausa('Almo√ßo')">üçΩÔ∏è Almo√ßo</button>
<button onclick="iniciarPausa('Reuni√£o')">üë• Reuni√£o</button>
<button onclick="iniciarPausa('Lanche')">‚òï Lanche</button>
<button onclick="iniciarPausa('Banheiro')">üöª Banheiro</button>
<button onclick="iniciarPausa('Livre')">‚è≥ Livre</button>
</div>

<button onclick="finalizarPausa()" style="margin-top:15px;background:#b91c1c;color:#fff">
Finalizar Pausa
</button>
</div>

<div class="grid">

<div class="card">
<h2>üìû Fila Telefone</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaTelefone"></tbody>
</table>
</div>

<div class="card">
<h2>üí¨ Fila Chat</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaChat"></tbody>
</table>
</div>

</div>

<div class="card adm">
<h2>üõ†Ô∏è Painel Administrativo (Tempo Real)</h2>
<table>
<thead>
<tr>
<th>Analista</th>
<th>Canal</th>
<th>Pausa Atual</th>
<th>Tempo Atual</th>
<th>Total Pausas</th>
<th>Status</th>
</tr>
</thead>
<tbody id="adminTabela"></tbody>
</table>
</div>

</div>

<script>
// ------------------ Vari√°veis ------------------
const analistas = {};
let editando = null;

// ------------------ Fun√ß√µes utilit√°rias ------------------
function toggleAdmin(){ adminPanel.style.display = adminPanel.style.display==="block"?"none":"block"; }
function formatarMinSec(s){ return String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0"); }
function formatarHora(s){ return String(Math.floor(s/3600)).padStart(2,"0")+":"+String(Math.floor((s%3600)/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0"); }

// ------------------ CRUD Analistas ------------------
function cadastrarAnalista(){
  const nome = analistaNome.value.trim();
  const canal = analistaCanal.value;
  if(!nome||!canal) return alert("Informe nome e canal");

  Backendless.Data.of("AnalistasPausa").save({
    nome, canal, pausaAtual:null, inicioPausa:null, totalTempo:0, aderencia:100
  }).then(()=>{
    analistaNome.value=""; analistaCanal.value="";
  });
}

function editarAnalista(id,nome,canal){
  analistaNome.value = nome;
  analistaCanal.value = canal;
  editando = id;
}

function excluirAnalista(id){
  if(!confirm("Deseja excluir o analista?")) return;
  Backendless.Data.of("AnalistasPausa").remove(id);
}

// ------------------ Pausas ------------------
function iniciarPausa(tipo){
  const select = document.getElementById("selectAnalista");
  const nome = select.value;
  if(!nome) return alert("Selecione o analista");

  const analista = Object.values(analistas).find(a=>a.nome===nome);
  if(!analista) return alert("Analista n√£o encontrado");
  if(analista.pausaAtual) return alert("Analista j√° est√° em pausa");

  Backendless.Data.of("AnalistasPausa").save({
    objectId: analista.objectId,
    pausaAtual: tipo,
    inicioPausa: Date.now()
  });
}

function finalizarPausa(){
  const select = document.getElementById("selectAnalista");
  const nome = select.value;
  if(!nome) return alert("Selecione o analista");

  const analista = Object.values(analistas).find(a=>a.nome===nome);
  if(!analista) return alert("Analista n√£o encontrado");
  if(!analista.pausaAtual) return alert("Analista n√£o est√° em pausa");

  const duracao = Math.floor((Date.now()-analista.inicioPausa)/1000);
  let novaAderencia = analista.aderencia;
  if(analista.pausaAtual==="Banheiro"||analista.pausaAtual==="Livre"){
    novaAderencia = Math.max(0, analista.aderencia - Math.floor(duracao/180));
  }

  Backendless.Data.of("AnalistasPausa").save({
    objectId: analista.objectId,
    pausaAtual: null,
    inicioPausa: null,
    totalTempo: (analista.totalTempo||0)+duracao,
    aderencia: novaAderencia
  });
}

// ------------------ Atualiza√ß√£o da tela ------------------
function atualizarTudo(){
  const select = document.getElementById("selectAnalista");
  select.innerHTML = `<option value="">Selecione o analista</option>`;
  const filaTel = document.getElementById("filaTelefone");
  const filaChat = document.getElementById("filaChat");
  const adminTab = document.getElementById("adminTabela");

  filaTel.innerHTML=""; filaChat.innerHTML=""; adminTab.innerHTML="";

  Object.values(analistas).forEach(a=>{
    select.innerHTML += `<option value="${a.nome}">${a.nome}</option>`;

    const tempoAtual = a.pausaAtual ? Math.floor((Date.now()-a.inicioPausa)/1000) : 0;

    if(a.pausaAtual){
      const linha = `<tr><td>${a.nome}</td><td>${a.pausaAtual}</td><td>${formatarMinSec(tempoAtual)}</td></tr>`;
      a.canal==="Telefone"?filaTel.innerHTML+=linha:filaChat.innerHTML+=linha;
    }

    adminTab.innerHTML+=`
      <tr>
        <td>${a.nome}</td>
        <td><span class="badge ${a.canal.toLowerCase()}">${a.canal}</span></td>
        <td>${a.pausaAtual||"-"}</td>
        <td>${a.pausaAtual?formatarMinSec(tempoAtual):"-"}</td>
        <td><strong>${formatarHora(a.totalTempo||0)}</strong></td>
        <td class="status ${a.pausaAtual?"vermelho":"verde"}">
          <span class="bolinha ${a.pausaAtual?"vermelho":"verde"}"></span>
          ${a.pausaAtual?"Em pausa":"Dispon√≠vel"} | Ader√™ncia: ${a.aderencia||100}%
        </td>
      </tr>`;
  });
}

// ------------------ Carregar Analistas ------------------
Backendless.Data.of("AnalistasPausa").find().then(res=>{
  res.forEach(a=>analistas[a.objectId]=a);
  atualizarTudo();
});

// ------------------ Realtime ------------------
Backendless.Data.of("AnalistasPausa").RT()
.subscribe(Backendless.Data.SubscriptionMode.CREATE, r=>{ analistas[r.object.objectId]=r.object; atualizarTudo(); })
.subscribe(Backendless.Data.SubscriptionMode.UPDATE, r=>{ analistas[r.object.objectId]=r.object; atualizarTudo(); })
.subscribe(Backendless.Data.SubscriptionMode.DELETE, r=>{ delete analistas[r.object.objectId]; atualizarTudo(); });

// Atualiza tempo das pausas a cada segundo
setInterval(atualizarTudo,1000);
</script>

</body>
</html>
