<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Atendimento TelefÃ´nico</title>

<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<script>
Backendless.initApp(
  "16519BB0-2CC5-4D6D-A7C8-CC9B9D69F91B",
  "FD19561E-7DE2-4E6B-AA75-2C846AF62F87"
);
</script>

<style>
*{ box-sizing:border-box; font-family:Arial }
body{ margin:0; background:#f4f6f8; color:#0f172a; }
header{ background:#001e36; color:#fff; padding:15px; text-align:center; font-size:20px; font-weight:bold; position:relative }
.admin-btn{ position:absolute; right:20px; top:12px; background:#0b3c5d; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer }
.admin-panel{ position:fixed; top:60px; right:20px; width:360px; background:#fff; padding:20px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); display:none; z-index:999 }
.admin-panel h2{ margin-top:0; color:#001e36 }
.admin-panel button.close{ background:#b91c1c; color:#fff; width:100%; margin-top:10px }
.container{ max-width:1300px; margin:20px auto; padding:20px }
.card{ background:#fff; padding:20px; border-radius:14px; margin-bottom:20px; box-shadow:0 6px 18px rgba(0,0,0,.08) }
h2{ margin-top:0; color:#001e36 }
input,select,button{ padding:10px; border-radius:8px; border:1px solid #cbd5e1 }
button{ cursor:pointer; font-weight:bold }
.pause-buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
.pause-buttons button{ background:#e5e7eb; color:#001e36 }
.pause-buttons button:hover{ background:#cbd5e1 }
.adm{ border:2px dashed #001e36 }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px }
table{ width:100%; border-collapse:collapse }
th,td{ border:1px solid #e5e7eb; padding:8px; text-align:center }
th{ background:#eef2f6; color:#001e36 }
.status{ display:flex; align-items:center; justify-content:center; gap:6px; font-weight:bold }
.bolinha{ width:10px; height:10px; border-radius:50% }
.verde{ background:#16a34a; color:#14532d }
.vermelho{ background:#dc2626; color:#7f1d1d }
.badge{ padding:3px 8px; border-radius:10px; font-size:12px; font-weight:bold }
.chat{ background:#e0f2fe; color:#075985 }
.telefone{ background:#e5e7eb; color:#001e36 }
.lista-analistas{ margin-top:15px }
.lista-analistas div{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:6px }
.lista-analistas button{ padding:4px 6px; font-size:11px }
.admin-actions{ display:flex; gap:10px; margin-bottom:10px }
</style>
</head>

<body>

<header>
ğŸ“ Painel de Atendimento
<button class="admin-btn" onclick="toggleAdmin()">ğŸ› ï¸ Admin</button>
</header>

<div class="admin-panel" id="adminPanel">
<h2>ğŸ‘¤ Cadastro do Analista</h2>

<input id="analistaNome" placeholder="Nome do Analista"><br><br>

<select id="analistaCanal">
<option value="">Canal</option>
<option value="Telefone">ğŸ“ Telefone</option>
<option value="Chat">ğŸ’¬ Chat</option>
</select><br><br>

<button onclick="cadastrarAnalista()">Salvar</button>

<div class="lista-analistas" id="listaAnalistas"></div>

<button class="close" onclick="toggleAdmin()">Fechar</button>
</div>

<div class="container">

<div class="card">
<h2>â¸ï¸ Controle de Pausas</h2>

<select id="selectAnalista">
<option value="">Selecione o analista</option>
</select><br><br>

<div class="pause-buttons">
<button onclick="iniciarPausa('AlmoÃ§o')">ğŸ½ï¸ AlmoÃ§o</button>
<button onclick="iniciarPausa('ReuniÃ£o')">ğŸ‘¥ ReuniÃ£o</button>
<button onclick="iniciarPausa('Treinamento')">ğŸ“˜ Treinamento</button>
<button onclick="iniciarPausa('Banheiro')">ğŸš» Banheiro</button>
<button onclick="iniciarPausa('Livre')">â³ Livre</button>
</div>

<button onclick="finalizarPausa()" style="margin-top:15px;background:#b91c1c;color:#fff">
Finalizar Pausa
</button>
</div>

<div class="grid">

<div class="card">
<h2>ğŸ“ Fila Telefone</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaTelefone"></tbody>
</table>
</div>

<div class="card">
<h2>ğŸ’¬ Fila Chat</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaChat"></tbody>
</table>
</div>

</div>

<div class="card adm">
<h2>ğŸ› ï¸ Painel Administrativo (Tempo Real)</h2>

<div class="admin-actions">
<button onclick="exportarDados()">ğŸ“¤ Exportar Dados</button>
<button onclick="atualizarStatusPausas()">ğŸ”„ Atualizar Status</button>
</div>

<table>
<thead>
<tr>
<th>Analista</th>
<th>Canal</th>
<th>Pausa Atual</th>
<th>Tempo Atual</th>
<th>Total Pausas</th>
<th>Status</th>
</tr>
</thead>
<tbody id="adminTabela"></tbody>
</table>
</div>

</div>

<script>
const analistas = {};

function toggleAdmin(){ adminPanel.style.display = adminPanel.style.display==="block"?"none":"block"; }
function formatarMinSec(s){ return String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0"); }
function formatarHora(s){ return String(Math.floor(s/3600)).padStart(2,"0")+":"+String(Math.floor((s%3600)/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0"); }

// -------- CRUD --------
function cadastrarAnalista(){
  const nome = analistaNome.value.trim();
  const canal = analistaCanal.value;
  if(!nome || !canal) return alert("Informe nome e canal");

  Backendless.Data.of("AnalistasPausa").save({
    nome, canal, pausaAtual:null, inicioPausa:null, totalTempo:0, aderencia:100
  }).then(a=>{
    analistas[a.objectId]=a;
    atualizarTudo();
  });

  analistaNome.value="";
  analistaCanal.value="";
}

// -------- AÃ‡Ã•ES ADMIN --------
function excluirAnalista(id){
  if(confirm("Excluir analista?")){
    Backendless.Data.of("AnalistasPausa").remove({objectId:id});
  }
}
function zerarAderencia(id){
  Backendless.Data.of("AnalistasPausa").save({objectId:id, aderencia:100});
}
function zerarPausas(id){
  Backendless.Data.of("AnalistasPausa").save({objectId:id, totalTempo:0});
}

// -------- PAUSAS --------
function iniciarPausa(tipo){
  const nome = selectAnalista.value;
  if(!nome) return alert("Selecione o analista");
  const a = Object.values(analistas).find(x=>x.nome===nome);
  if(!a || a.pausaAtual) return alert("Analista jÃ¡ estÃ¡ em pausa");

  a.pausaAtual = tipo;
  a.inicioPausa = Date.now();
  atualizarTudo();
  Backendless.Data.of("AnalistasPausa").save({objectId:a.objectId, pausaAtual:tipo, inicioPausa:a.inicioPausa});
}

function finalizarPausa(){
  const nome = selectAnalista.value;
  if(!nome) return alert("Selecione o analista");
  const a = Object.values(analistas).find(x=>x.nome===nome);
  if(!a || !a.pausaAtual) return alert("Analista nÃ£o estÃ¡ em pausa");

  const dur = Math.floor((Date.now()-a.inicioPausa)/1000);
  if(a.pausaAtual==="Banheiro"||a.pausaAtual==="Livre")
    a.aderencia=Math.max(0,a.aderencia-Math.floor(dur/180));

  a.totalTempo=(a.totalTempo||0)+dur;
  a.pausaAtual=null;
  a.inicioPausa=null;

  atualizarTudo();
  Backendless.Data.of("AnalistasPausa").save(a);
}

// -------- EXPORTAR --------
function exportarDados(){
  let csv = "Analista,Canal,Pausa Atual,Tempo Atual,Total Pausas,AderÃªncia\n";
  Object.values(analistas).forEach(a=>{
    const tempoAtual = a.pausaAtual ? formatarMinSec(Math.floor((Date.now()-a.inicioPausa)/1000)) : "-";
    csv += `${a.nome},${a.canal},${a.pausaAtual||"-"},${tempoAtual},${formatarHora(a.totalTempo||0)},${a.aderencia||100}%\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "painel_pausas.csv";
  link.click();
}

// -------- ATUALIZAR STATUS --------
function atualizarStatusPausas(){
  Backendless.Data.of("AnalistasPausa").find().then(res=>{
    res.forEach(a=>analistas[a.objectId]=a);
    atualizarTudo();
  });
}

// -------- ATUALIZAR --------
function atualizarTudo(){
  selectAnalista.innerHTML=`<option value="">Selecione o analista</option>`;
  filaTelefone.innerHTML=""; filaChat.innerHTML=""; adminTabela.innerHTML="";
  listaAnalistas.innerHTML="";

  Object.values(analistas).forEach(a=>{
    selectAnalista.innerHTML+=`<option>${a.nome}</option>`;

    if(a.pausaAtual){
      const tempo=Math.floor((Date.now()-a.inicioPausa)/1000);
      const linha=`<tr><td>${a.nome}</td><td>${a.pausaAtual}</td><td>${formatarMinSec(tempo)}</td></tr>`;
      a.canal==="Telefone"?filaTelefone.innerHTML+=linha:filaChat.innerHTML+=linha;
    }

    adminTabela.innerHTML+=`
    <tr>
      <td>${a.nome}</td>
      <td><span class="badge ${a.canal.toLowerCase()}">${a.canal}</span></td>
      <td>${a.pausaAtual||"-"}</td>
      <td>${a.pausaAtual?formatarMinSec(Math.floor((Date.now()-a.inicioPausa)/1000)):"-"}</td>
      <td><strong>${formatarHora(a.totalTempo||0)}</strong></td>
      <td class="status ${a.pausaAtual?"vermelho":"verde"}">
        <span class="bolinha ${a.pausaAtual?"vermelho":"verde"}"></span>
        ${a.pausaAtual?"Em pausa":"DisponÃ­vel"} | AderÃªncia: ${a.aderencia||100}%
      </td>
    </tr>`;

    listaAnalistas.innerHTML+=`
    <div>
      <span>${a.nome}</span>
      <div>
        <button onclick="zerarAderencia('${a.objectId}')">AderÃªncia</button>
        <button onclick="zerarPausas('${a.objectId}')">Pausas</button>
        <button onclick="excluirAnalista('${a.objectId}')" style="background:#dc2626;color:#fff">Excluir</button>
      </div>
    </div>`;
  });
}

// -------- LOAD + REALTIME --------
Backendless.Data.of("AnalistasPausa").find().then(res=>{
  res.forEach(a=>analistas[a.objectId]=a);
  atualizarTudo();
});

Backendless.Data.of("AnalistasPausa").RT()
.subscribe(Backendless.Data.SubscriptionMode.CREATE, r=>{analistas[r.object.objectId]=r.object; atualizarTudo();})
.subscribe(Backendless.Data.SubscriptionMode.UPDATE, r=>{analistas[r.object.objectId]=r.object; atualizarTudo();})
.subscribe(Backendless.Data.SubscriptionMode.DELETE, r=>{delete analistas[r.object.objectId]; atualizarTudo();});

requestAnimationFrame(function loop(){ atualizarTudo(); requestAnimationFrame(loop); });
</script>

</body>
</html>
