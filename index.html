<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Atendimento Telef√¥nico</title>

<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<script>
Backendless.initApp(
  "16519BB0-2CC5-4D6D-A7C8-CC9B9D69F91B",
  "FD19561E-7DE2-4E6B-AA75-2C846AF62F87"
);
</script>

<style>
*{
  box-sizing:border-box;
  font-family:Arial
}

body{
  margin:0;
  background:#f4f6f8;
  color:#0f172a;
}

header{
  background:#001e36;
  color:#ffffff;
  padding:15px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
  position:relative
}

.admin-btn{
  position:absolute;
  right:20px;
  top:12px;
  background:#0b3c5d;
  color:#ffffff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer
}

.admin-panel{
  position:fixed;
  top:60px;
  right:20px;
  width:360px;
  background:#ffffff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  display:none;
  z-index:999
}

.admin-panel h2{
  margin-top:0;
  color:#001e36
}

.admin-panel button.close{
  background:#b91c1c;
  color:#ffffff;
  width:100%;
  margin-top:10px
}

.container{
  max-width:1300px;
  margin:20px auto;
  padding:20px
}

.card{
  background:#ffffff;
  padding:20px;
  border-radius:14px;
  margin-bottom:20px;
  box-shadow:0 6px 18px rgba(0,0,0,.08)
}

h2{
  margin-top:0;
  color:#001e36
}

input,select,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #cbd5e1
}

button{
  cursor:pointer;
  font-weight:bold
}

.pause-buttons{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px
}

.pause-buttons button{
  background:#e5e7eb;
  color:#001e36
}

.pause-buttons button:hover{
  background:#cbd5e1
}

.adm{
  border:2px dashed #001e36
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px
}

table{
  width:100%;
  border-collapse:collapse
}

th,td{
  border:1px solid #e5e7eb;
  padding:8px;
  text-align:center
}

th{
  background:#eef2f6;
  color:#001e36
}

.status{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  font-weight:bold
}

.bolinha{
  width:10px;
  height:10px;
  border-radius:50%
}

.verde{
  background:#16a34a;
  color:#14532d
}

.vermelho{
  background:#dc2626;
  color:#7f1d1d
}

.badge{
  padding:3px 8px;
  border-radius:10px;
  font-size:12px;
  font-weight:bold
}

.chat{
  background:#e0f2fe;
  color:#075985
}

.telefone{
  background:#e5e7eb;
  color:#001e36
}

.lista-analistas{
  margin-top:15px
}

.lista-analistas div{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px
}

.lista-analistas button{
  padding:4px 8px;
  font-size:12px
}
</style>
</head>

<body>

<header>
üìû Painel de Atendimento
<button class="admin-btn" onclick="toggleAdmin()">üõ†Ô∏è Admin</button>
</header>

<div class="admin-panel" id="adminPanel">
<h2>üë§ Cadastro do Analista</h2>

<input id="analistaNome" placeholder="Nome do Analista"><br><br>

<select id="analistaCanal">
<option value="">Canal</option>
<option value="Telefone">üìû Telefone</option>
<option value="Chat">üí¨ Chat</option>
</select><br><br>

<button onclick="cadastrarAnalista()">Salvar</button>

<div class="lista-analistas" id="listaAnalistas"></div>

<button class="close" onclick="toggleAdmin()">Fechar</button>
</div>

<div class="container">

<div class="card">
<h2>‚è∏Ô∏è Controle de Pausas</h2>

<select id="selectAnalista">
<option value="">Selecione o analista</option>
</select><br><br>

<div class="pause-buttons">
<button onclick="iniciarPausa('Almo√ßo')">üçΩÔ∏è Almo√ßo</button>
<button onclick="iniciarPausa('Reuni√£o')">üë• Reuni√£o</button>
<button onclick="iniciarPausa('Lanche')">‚òï Lanche</button>
<button onclick="iniciarPausa('Banheiro')">üöª Banheiro</button>
<button onclick="iniciarPausa('Livre')">‚è≥ Livre</button>
</div>

<button onclick="finalizarPausa()" style="margin-top:15px;background:#b91c1c;color:#fff">
Finalizar Pausa
</button>
</div>

<div class="grid">

<div class="card">
<h2>üìû Fila Telefone</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaTelefone"></tbody>
</table>
</div>

<div class="card">
<h2>üí¨ Fila Chat</h2>
<table>
<thead>
<tr><th>Analista</th><th>Pausa</th><th>Tempo</th></tr>
</thead>
<tbody id="filaChat"></tbody>
</table>
</div>

</div>

<div class="card adm">
<h2>üõ†Ô∏è Painel Administrativo (Tempo Real)</h2>
<table>
<thead>
<tr>
<th>Analista</th>
<th>Canal</th>
<th>Pausa Atual</th>
<th>Tempo Atual</th>
<th>Total Pausas</th>
<th>Status</th>
</tr>
</thead>
<tbody id="adminTabela"></tbody>
</table>
</div>

</div>

<script>
function dataHoje(){
  const d=new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

const analistas={}, pausasAtivas={}, totalTempoAnalista={}, aderenciaAnalista={};
let estadoId=null;
let editando=null;

function toggleAdmin(){
  adminPanel.style.display=adminPanel.style.display==="block"?"none":"block";
}

function cadastrarAnalista(){
  if(!analistaNome.value||!analistaCanal.value) return alert("Informe nome e canal");

  analistas[analistaNome.value]=analistaCanal.value;
  aderenciaAnalista[analistaNome.value]=aderenciaAnalista[analistaNome.value] ?? 100;

  editando=null;
  analistaNome.value="";
  analistaCanal.value="";

  atualizarSelectAnalistas();
  atualizarListaAdmin();
  atualizarTudo();
  salvarEstado();
}

function editarAnalista(nome){
  analistaNome.value=nome;
  analistaCanal.value=analistas[nome];
  editando=nome;
}

function excluirAnalista(nome){
  if(!confirm("Deseja excluir o analista?")) return;
  delete analistas[nome];
  delete pausasAtivas[nome];
  delete totalTempoAnalista[nome];
  delete aderenciaAnalista[nome];
  atualizarTudo();
  salvarEstado();
}

function atualizarListaAdmin(){
  listaAnalistas.innerHTML="";
  Object.keys(analistas).forEach(n=>{
    listaAnalistas.innerHTML+=`
      <div>
        <strong>${n}</strong>
        <span>
          <button onclick="editarAnalista('${n}')">‚úèÔ∏è</button>
          <button onclick="excluirAnalista('${n}')" style="background:#b91c1c;color:#fff">üóëÔ∏è</button>
        </span>
      </div>`;
  });
}

function atualizarSelectAnalistas(){
  selectAnalista.innerHTML=`<option value="">Selecione o analista</option>`;
  Object.keys(analistas).forEach(n=>{
    selectAnalista.innerHTML+=`<option value="${n}">${n}</option>`;
  });
}

function iniciarPausa(tipo){
  const nome=selectAnalista.value;
  if(!nome) return alert("Selecione o analista");
  if(pausasAtivas[nome]) return alert("J√° est√° em pausa");
  pausasAtivas[nome]={ tipo, inicio: Date.now() };
  atualizarTudo();
  salvarEstado();
}

function finalizarPausa(){
  const nome=selectAnalista.value;
  const p=pausasAtivas[nome];
  if(!p) return alert("Analista n√£o est√° em pausa");

  const duracao=Math.floor((Date.now()-p.inicio)/1000);
  totalTempoAnalista[nome]=(totalTempoAnalista[nome]||0)+duracao;

  if(p.tipo==="Banheiro"||p.tipo==="Livre"){
    const perda=Math.floor(duracao/180);
    aderenciaAnalista[nome]=Math.max(0,(aderenciaAnalista[nome]??100)-perda);
  }

  delete pausasAtivas[nome];
  atualizarTudo();
  salvarEstado();
}

function atualizarTudo(){
  adminTabela.innerHTML="";
  filaTelefone.innerHTML="";
  filaChat.innerHTML="";

  Object.keys(analistas).forEach(nome=>{
    const canal=analistas[nome];
    const ativo=pausasAtivas[nome];
    const tempoAtual=ativo?Math.floor((Date.now()-ativo.inicio)/1000):0;
    const aderencia=aderenciaAnalista[nome]??100;

    if(ativo){
      const linha=`<tr><td>${nome}</td><td>${ativo.tipo}</td><td>${formatarMinSec(tempoAtual)}</td></tr>`;
      canal==="Telefone"?filaTelefone.innerHTML+=linha:filaChat.innerHTML+=linha;
    }

    adminTabela.innerHTML+=`
      <tr>
        <td>${nome}</td>
        <td><span class="badge ${canal.toLowerCase()}">${canal}</span></td>
        <td>${ativo?ativo.tipo:"-"}</td>
        <td>${ativo?formatarMinSec(tempoAtual):"-"}</td>
        <td><strong>${formatarHora(totalTempoAnalista[nome]||0)}</strong></td>
        <td class="status ${ativo?"vermelho":"verde"}">
          <span class="bolinha ${ativo?"vermelho":"verde"}"></span>
          ${ativo?"Em pausa":"Dispon√≠vel"} | Ader√™ncia: ${aderencia}%
        </td>
      </tr>`;
  });
}

setInterval(atualizarTudo,1000);

function formatarMinSec(s){
  return String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0");
}

function formatarHora(s){
  return String(Math.floor(s/3600)).padStart(2,"0")+":"+String(Math.floor((s%3600)/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0");
}

function salvarEstado(){
  const estado={analistas,totalTempoAnalista,pausasAtivas,aderenciaAnalista,dataControle:dataHoje()};
  const data={estado:JSON.stringify(estado)};
  if(estadoId) data.objectId=estadoId;
  Backendless.Data.of("PainelEstado").save(data).then(r=>{
    estadoId=r.objectId;
  });
}

// Carrega o estado inicial
function carregarEstado(){
  Backendless.Data.of("PainelEstado").find().then(r=>{
    if(!r.length) return;
    estadoId=r[0].objectId;
    const d=JSON.parse(r[0].estado);
    Object.assign(analistas,d.analistas||{});
    Object.assign(totalTempoAnalista,d.totalTempoAnalista||{});
    Object.assign(pausasAtivas,d.pausasAtivas||{});
    Object.assign(aderenciaAnalista,d.aderenciaAnalista||{});
    atualizarSelectAnalistas();
    atualizarListaAdmin();
    atualizarTudo();
  });
}

carregarEstado();

// ====== Realtime Backendless ======
Backendless.Data.of("PainelEstado").RT().subscribe(
  Backendless.Data.SubscriptionMode.UPDATE,
  function(update){
    if(update.object.estado){
      const d=JSON.parse(update.object.estado);
      Object.assign(analistas,d.analistas||{});
      Object.assign(totalTempoAnalista,d.totalTempoAnalista||{});
      Object.assign(pausasAtivas,d.pausasAtivas||{});
      Object.assign(aderenciaAnalista,d.aderenciaAnalista||{});
      atualizarSelectAnalistas();
      atualizarListaAdmin();
      atualizarTudo();
    }
  }
);
</script>

</body>
</html>
